import numpy as np
 
class ElementStEP(object):
    
    is_real_valued = True
    
    def __init__(self, P: float = 1.0, c: float = 0):
        """
        Initializes the ArchBeamSSM parameters.

        :param P: Amplitude multiplier of the external force
        """
        self.P = P

        self.omega0 = 3231.28305

        B = np.array([-5e-10+3231.28305j, -3231.28305-5e-10j])
        self.linear_coefficient = np.array([
            [B[0].real-c, B[1].real],
            [B[0].imag, B[1].imag-c]
        ])
        
        self.dimension = self.linear_coefficient.shape[0] # 1 dimensional in second order and 2 dimensional in first order
        self.polynomial_degree = 5

    def external_term(self, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Calculates the external forcing term.

        :param adimensional_time: Time at which to evaluate the external force
        :return: External force array
        """
        x1 = self.P * np.cos(adimensional_time)
        x3 = self.P * np.sin(adimensional_time)

        # 11 terms
        fext = \
            ((-1.08407107e-36-7.73686476e-10j)) * x1 +\
            ((7.73686476e-10-1.08407107e-36j)) * x3 +\
            ((-1.91909302e-51-1.96945133e-37j)) * (x1**3) +\
            ((1.96945133e-37-1.91909302e-51j)) * (x1**2) * x3 +\
            ((-1.91909302e-51-1.96945133e-37j)) * x1 * (x3**2) +\
            ((1.96945133e-37-1.91909302e-51j)) * (x3**3)

        return np.array([[fext.real, fext.imag]]).transpose()
    
    def linear_term(self, state: np.ndarray) -> np.ndarray:
        """
        Calculates the linear term.

        :param state: State vector
        :return: Linear term array
        """
        return self.linear_coefficient @ state

    def nonlinear_term(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Calculates the nonlinear term.

        :param state: State vector
        :return: Nonlinear term array
        """
        x0 = state[..., 0:1, :]
        x2 = state[..., 1:2, :]

        x1 = self.P * np.array(np.cos(adimensional_time))[...,np.newaxis,np.newaxis]
        x3 = self.P * np.array(np.sin(adimensional_time))[...,np.newaxis,np.newaxis]

        # 26 terms # 29 terms
        fnl = \
            ((1.0723728e-12-2.09514652j)) * (x0**3) +\
            ((-1.177631914e-24+2.56624011e-12j)) * (x0**2) * x1 +\
            ((2.09514652+1.0723728e-12j)) * (x0**2) * x2 +\
            ((-3.06789425e-12-1.4205068460000001e-24j)) * (x0**2) * x3 +\
            ((-1.0723176999999993e-38-1.3078191910000001e-24j)) * x0 * (x1**2) +\
            ((5.016541399999999e-13+2.4287493200000006e-25j)) * x0 * x1 * x2 +\
            ((3.36727458e-24+2.31444942e-37j)) * x0 * x1 * x3 +\
            ((1.0723728e-12-2.09514652j)) * x0 * (x2**2) +\
            ((2.4287493200000006e-25-5.016541399999999e-13j)) * x0 * x2 * x3 +\
            ((-2.42168119e-37+2.0594553890000002e-24j)) * x0 * (x3**2) +\
            ((-2.0594553890000002e-24-2.42168119e-37j)) * (x1**2) * x2 +\
            ((-1.4205068460000001e-24+3.06789425e-12j)) * x1 * (x2**2) +\
            ((2.31444942e-37-3.36727458e-24j)) * x1 * x2 * x3 +\
            ((2.09514652+1.0723728e-12j)) * (x2**3) +\
            ((-2.56624011e-12-1.177631914e-24j)) * (x2**2) * x3 +\
            ((1.3078191910000001e-24-1.0723176999999993e-38j)) * x2 * (x3**2) +\
            ((-1.21084119e-14+0.00355744829j)) * (x0**5) +\
            ((3.89725293e-26-1.2767661330000002e-14j)) * (x0**4) * x1 +\
            ((-0.0035574482899999992-1.2108411900000003e-14j)) * (x0**4) * x2 +\
            ((2.568345847e-14+6.48131303e-26j)) * (x0**4) * x3 +\
            ((-1.9384629289000007e-38+7.941192923999998e-27j)) * (x0**3) * (x1**2) +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * (x0**3) * x1 * x2 +\
            ((-7.2455394152e-26-1.7459792682200002e-37j)) * (x0**3) * x1 * x3 +\
            ((-2.4216823800000007e-14+0.0071148965799999984j)) * (x0**3) * (x2**2) +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * (x0**3) * x2 * x3 +\
            ((1.58101175089e-37-6.1582200924e-26j)) * (x0**3) * (x3**2) +\
            ((-8.009415048e-50+2.927362029e-38j)) * (x0**2) * (x1**3) +\
            ((6.4514201228e-26+1.5521329753300002e-37j)) * (x0**2) * (x1**2) * x2 +\
            ((2.130134428999999e-38+1.8818995279999971e-50j)) * (x0**2) * (x1**2) * x3 +\
            ((1.0378565960000003e-25-3.8451119799999997e-14j)) * (x0**2) * x1 * (x2**2) +\
            ((-1.8037368193400001e-37+6.6591393544e-26j)) * (x0**2) * x1 * x2 * x3 +\
            ((-3.0455705328e-49+1.3463186789e-37j)) * (x0**2) * x1 * (x3**2) +\
            ((-0.007114896579999999-2.4216823800000004e-14j)) * (x0**2) * (x2**3) +\
            ((3.8451119799999997e-14+1.0378565960000003e-25j)) * (x0**2) * (x2**2) * x3 +\
            ((-1.0873193227999998e-26-1.6496751732999992e-38j)) * (x0**2) * x2 * (x3**2) +\
            ((-8.405690331e-38-2.0564390752e-49j)) * (x0**2) * (x3**3) +\
            ((8.9186385e-62-4.599356783e-50j)) * x0 * (x1**4) +\
            ((-5.057496458e-38-9.891314576e-50j)) * x0 * (x1**3) * x2 +\
            ((1.0231687560000002e-49+2.09210084e-61j)) * x0 * (x1**3) * x3 +\
            ((-1.6496751732999992e-38+1.0873193227999998e-26j)) * x0 * (x1**2) * (x2**2) +\
            ((3.5001265983999996e-49-1.6014153061999997e-37j)) * x0 * (x1**2) * x2 * x3 +\
            ((-3.0837314e-62+1.0329739939999996e-50j)) * x0 * (x1**2) * (x3**2) +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * x0 * x1 * (x2**3) +\
            ((-6.6591393544e-26-1.8037368193400001e-37j)) * x0 * x1 * (x2**2) * x3 +\
            ((1.6014153062e-37+3.5001265983999996e-49j)) * x0 * x1 * x2 * (x3**2) +\
            ((1.0231687560000002e-49+2.09210084e-61j)) * x0 * x1 * (x3**3) +\
            ((-1.2108411900000003e-14+0.0035574482899999992j)) * x0 * (x2**4) +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * x0 * (x2**3) * x3 +\
            ((1.5521329753300002e-37-6.4514201228e-26j)) * x0 * (x2**2) * (x3**2) +\
            ((-9.891314576e-50+5.057496458e-38j)) * x0 * x2 * (x3**3) +\
            ((-1.20023699e-61+5.632330777e-50j)) * x0 * (x3**4) +\
            ((-5.632330777e-50-1.20023699e-61j)) * (x1**4) * x2 +\
            ((-2.0564390752e-49+8.405690331e-38j)) * (x1**3) * (x2**2) +\
            ((2.09210084e-61-1.0231687560000002e-49j)) * (x1**3) * x2 * x3 +\
            ((6.1582200924e-26+1.58101175089e-37j)) * (x1**2) * (x2**3) +\
            ((-1.3463186789e-37-3.0455705328e-49j)) * (x1**2) * (x2**2) * x3 +\
            ((-1.0329739939999996e-50-3.0837314000000034e-62j)) * (x1**2) * x2 * (x3**2) +\
            ((6.48131303e-26-2.568345847e-14j)) * x1 * (x2**4) +\
            ((-1.7459792682200002e-37+7.2455394152e-26j)) * x1 * (x2**3) * x3 +\
            ((1.8818995279999971e-50-2.130134428999999e-38j)) * x1 * (x2**2) * (x3**2) +\
            ((2.09210084e-61-1.0231687560000002e-49j)) * x1 * x2 * (x3**3) +\
            ((-0.00355744829-1.21084119e-14j)) * (x2**5) +\
            ((1.2767661330000002e-14+3.89725293e-26j)) * (x2**4) * x3 +\
            ((-7.941192923999998e-27-1.9384629289000007e-38j)) * (x2**3) * (x3**2) +\
            ((-2.927362029e-38-8.009415048e-50j)) * (x2**2) * (x3**3) +\
            ((4.599356783e-50+8.9186385e-62j)) * x2 * (x3**4)
        
        return np.concatenate((fnl.real, fnl.imag), axis=-2)
    
    def all_terms(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Combines all terms (linear, nonlinear, external) to compute the total force.

        :param state: State vector
        :param adimensional_time: Time for evaluating external force
        :return: Total force array
        """
        return self.linear_term(state) + \
                self.nonlinear_term(state, adimensional_time) + \
                self.external_term(adimensional_time)
            
    def jacobian_nonlinear_term(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Computes the Jacobian of the nonlinear term.

        :param state: State vector
        :return: Jacobian of the nonlinear term
        """
        x0 = state[..., 0:1, :]
        x2 = state[..., 1:2, :]

        x1 = self.P * np.array(np.cos(adimensional_time))[...,np.newaxis,np.newaxis]
        x3 = self.P * np.array(np.sin(adimensional_time))[...,np.newaxis,np.newaxis]

        dx0 = \
            ((1.0723728e-12-2.09514652j)) * 3 * (x0**2) +\
            ((-1.177631914e-24+2.56624011e-12j)) * 2 * x0 * x1 +\
            ((2.09514652+1.0723728e-12j)) * 2 * x0 * x2 +\
            ((-3.06789425e-12-1.4205068460000001e-24j)) * 2 * x0 * x3 +\
            ((-1.0723176999999993e-38-1.3078191910000001e-24j)) * (x1**2) +\
            ((5.016541399999999e-13+2.4287493200000006e-25j)) * x1 * x2 +\
            ((3.36727458e-24+2.31444942e-37j)) * x1 * x3 +\
            ((1.0723728e-12-2.09514652j)) * (x2**2) +\
            ((2.4287493200000006e-25-5.016541399999999e-13j)) * x2 * x3 +\
            ((-2.42168119e-37+2.0594553890000002e-24j)) * (x3**2) +\
            ((-1.21084119e-14+0.00355744829j)) * 5 * (x0**4) +\
            ((3.89725293e-26-1.2767661330000002e-14j)) * 4 * (x0**3) * x1 +\
            ((-0.0035574482899999992-1.2108411900000003e-14j)) * 4 * (x0**3) * x2 +\
            ((2.568345847e-14+6.48131303e-26j)) * 4 * (x0**3) * x3 +\
            ((-1.9384629289000007e-38+7.941192923999998e-27j)) * 3 * (x0**2) * (x1**2) +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * 3 * (x0**2) * x1 * x2 +\
            ((-7.2455394152e-26-1.7459792682200002e-37j)) * 3 * (x0**2) * x1 * x3 +\
            ((-2.4216823800000007e-14+0.0071148965799999984j)) * 3 * (x0**2) * (x2**2) +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * 3 * (x0**2) * x2 * x3 +\
            ((1.58101175089e-37-6.1582200924e-26j)) * 3 * (x0**2) * (x3**2) +\
            ((-8.009415048e-50+2.927362029e-38j)) * 2 * x0 * (x1**3) +\
            ((6.4514201228e-26+1.5521329753300002e-37j)) * 2 * x0 * (x1**2) * x2 +\
            ((2.130134428999999e-38+1.8818995279999971e-50j)) * 2 * x0 * (x1**2) * x3 +\
            ((1.0378565960000003e-25-3.8451119799999997e-14j)) * 2 * x0 * x1 * (x2**2) +\
            ((-1.8037368193400001e-37+6.6591393544e-26j)) * 2 * x0 * x1 * x2 * x3 +\
            ((-3.0455705328e-49+1.3463186789e-37j)) * 2 * x0 * x1 * (x3**2) +\
            ((-0.007114896579999999-2.4216823800000004e-14j)) * 2 * x0 * (x2**3) +\
            ((3.8451119799999997e-14+1.0378565960000003e-25j)) * 2 * x0 * (x2**2) * x3 +\
            ((-1.0873193227999998e-26-1.6496751732999992e-38j)) * 2 * x0 * x2 * (x3**2) +\
            ((-8.405690331e-38-2.0564390752e-49j)) * 2 * x0 * (x3**3) +\
            ((8.9186385e-62-4.599356783e-50j)) * (x1**4) +\
            ((-5.057496458e-38-9.891314576e-50j)) * (x1**3) * x2 +\
            ((1.0231687560000002e-49+2.09210084e-61j)) * (x1**3) * x3 +\
            ((-1.6496751732999992e-38+1.0873193227999998e-26j)) * (x1**2) * (x2**2) +\
            ((3.5001265983999996e-49-1.6014153061999997e-37j)) * (x1**2) * x2 * x3 +\
            ((-3.0837314e-62+1.0329739939999996e-50j)) * (x1**2) * (x3**2) +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * x1 * (x2**3) +\
            ((-6.6591393544e-26-1.8037368193400001e-37j)) * x1 * (x2**2) * x3 +\
            ((1.6014153062e-37+3.5001265983999996e-49j)) * x1 * x2 * (x3**2) +\
            ((1.0231687560000002e-49+2.09210084e-61j)) * x1 * (x3**3) +\
            ((-1.2108411900000003e-14+0.0035574482899999992j)) * (x2**4) +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * (x2**3) * x3 +\
            ((1.5521329753300002e-37-6.4514201228e-26j)) * (x2**2) * (x3**2) +\
            ((-9.891314576e-50+5.057496458e-38j)) * x2 * (x3**3) +\
            ((-1.20023699e-61+5.632330777e-50j)) * (x3**4)
            
        dx2 = \
            ((2.09514652+1.0723728e-12j)) * (x0**2) +\
            ((5.016541399999999e-13+2.4287493200000006e-25j)) * x0 * x1 +\
            ((1.0723728e-12-2.09514652j)) * 2 * x0 * x2 +\
            ((2.4287493200000006e-25-5.016541399999999e-13j)) * x0 * x3 +\
            ((-2.0594553890000002e-24-2.42168119e-37j)) * (x1**2) +\
            ((-1.4205068460000001e-24+3.06789425e-12j)) * 2 * x1 * x2 +\
            ((2.31444942e-37-3.36727458e-24j)) * x1 * x3 +\
            ((2.09514652+1.0723728e-12j)) * 3 * (x2**2) +\
            ((-2.56624011e-12-1.177631914e-24j)) * 2 * x2 * x3 +\
            ((1.3078191910000001e-24-1.0723176999999993e-38j)) * (x3**2) +\
            ((-0.0035574482899999992-1.2108411900000003e-14j)) * (x0**4) +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * (x0**3) * x1 +\
            ((-2.4216823800000007e-14+0.0071148965799999984j)) * 2 * (x0**3) * x2 +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * (x0**3) * x3 +\
            ((6.4514201228e-26+1.5521329753300002e-37j)) * (x0**2) * (x1**2) +\
            ((1.0378565960000003e-25-3.8451119799999997e-14j)) * 2 * (x0**2) * x1 * x2 +\
            ((-1.8037368193400001e-37+6.6591393544e-26j)) * (x0**2) * x1 * x3 +\
            ((-0.007114896579999999-2.4216823800000004e-14j)) * 3 * (x0**2) * (x2**2) +\
            ((3.8451119799999997e-14+1.0378565960000003e-25j)) * 2 * (x0**2) * x2 * x3 +\
            ((-1.0873193227999998e-26-1.6496751732999992e-38j)) * (x0**2) * (x3**2) +\
            ((-5.057496458e-38-9.891314576e-50j)) * x0 * (x1**3) +\
            ((-1.6496751732999992e-38+1.0873193227999998e-26j)) * 2 * x0 * (x1**2) * x2 +\
            ((3.5001265983999996e-49-1.6014153061999997e-37j)) * x0 * (x1**2) * x3 +\
            ((-1.291579714e-14-2.5840601000000003e-26j)) * 3 * x0 * x1 * (x2**2) +\
            ((-6.6591393544e-26-1.8037368193400001e-37j)) * 2 * x0 * x1 * x2 * x3 +\
            ((1.6014153062e-37+3.5001265983999996e-49j)) * x0 * x1 * (x3**2) +\
            ((-1.2108411900000003e-14+0.0035574482899999992j)) * 4 * x0 * (x2**3) +\
            ((-2.5840601000000003e-26+1.291579714e-14j)) * 3 * x0 * (x2**2) * x3 +\
            ((1.5521329753300002e-37-6.4514201228e-26j)) * 2 * x0 * x2 * (x3**2) +\
            ((-9.891314576e-50+5.057496458e-38j)) * x0 * (x3**3) +\
            ((-5.632330777e-50-1.20023699e-61j)) * (x1**4) +\
            ((-2.0564390752e-49+8.405690331e-38j)) * 2 * (x1**3) * x2 +\
            ((2.09210084e-61-1.0231687560000002e-49j)) * (x1**3) * x3 +\
            ((6.1582200924e-26+1.58101175089e-37j)) * 3 * (x1**2) * (x2**2) +\
            ((-1.3463186789e-37-3.0455705328e-49j)) * 2 * (x1**2) * x2 * x3 +\
            ((-1.0329739939999996e-50-3.0837314000000034e-62j)) * (x1**2) * (x3**2) +\
            ((6.48131303e-26-2.568345847e-14j)) * 4 * x1 * (x2**3) +\
            ((-1.7459792682200002e-37+7.2455394152e-26j)) * 3 * x1 * (x2**2) * x3 +\
            ((1.8818995279999971e-50-2.130134428999999e-38j)) * 2 * x1 * x2 * (x3**2) +\
            ((2.09210084e-61-1.0231687560000002e-49j)) * x1 * (x3**3) +\
            ((-0.00355744829-1.21084119e-14j)) * 5 * (x2**4) +\
            ((1.2767661330000002e-14+3.89725293e-26j)) * 4 * (x2**3) * x3 +\
            ((-7.941192923999998e-27-1.9384629289000007e-38j)) * 3 * (x2**2) * (x3**2) +\
            ((-2.927362029e-38-8.009415048e-50j)) * 2 * x2 * (x3**3) +\
            ((4.599356783e-50+8.9186385e-62j)) * (x3**4)

        jacobian0 = np.concatenate((dx0.real, dx2.real), axis=-1)
        jacobian1 = np.concatenate((dx0.imag, dx2.imag), axis=-1)
        
        return np.concatenate((jacobian0, jacobian1), axis=-2)

    
class ElementStEP_MORFE(object):
    
    is_real_valued = False
     
    def __init__(self, P: float = 1.0, c: float = 0, nonlinear: bool = True, preconditioner: float = 1.0):
        """
        Initializes the ArchBeamSSM parameters.

        :param P: Amplitude multiplier of the external force
        """
        self.P = P
        self.nonlinear = nonlinear
        
        #(-5.0e-10 + 3231.283054304668im)

        #B = np.array([-5e-10-3231.28305j, 3231.28305-5e-10j])
        self.linear_coefficient = np.array([
            [-5e-10+3231.28305j-c, 0.0],
            [0.0, -5e-10-3231.28305j-c]
        ])
        
        self.omega0 = abs(self.linear_coefficient[0,0].imag)
        
        self.preconditioner = preconditioner
        
        
        """self.omega0 = 3231.28305

        B = np.array([-5e-10+3231.28305j, -3231.28305-5e-10j])
        self.linear_coefficient = np.array([
            [B[0].real-c, B[1].real],
            [B[0].imag, B[1].imag-c]
        ])
        """
        self.dimension = self.linear_coefficient.shape[0]
        self.polynomial_degree = 3

    def external_term(self, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Calculates the external forcing term.

        :param adimensional_time: Time at which to evaluate the external force
        :return: External force array
        """
        
        cos_aux = self.P * np.cos(adimensional_time)
        sin_aux = self.P * np.sin(adimensional_time)
        
        x1 = cos_aux + 1j*sin_aux
        x3 = np.conj(x1)
        
        # 11 terms
        fext1 = \
            ((-1.0840710719358566e-36 - 7.73686476234119e-10j)) * x1 +\
            ((0.0 + 0.0j)) * x3
            
        fext2 = \
            ((0.0 + 0.0j)) * x1 +\
            ((-2.4297277067572883e-38 + 7.73686476234119e-10j)) * x3
            
        if self.nonlinear:
            fext1 += \
                ((0.0 + 0.0j)) * (x1**3) +\
                ((-1.9190930155250864e-51-1.9694513250391543e-37j)) * (x1**2) * x3 +\
                ((0.0 - 0.0j)) * x1 * (x3**2) +\
                ((0.0 - 0.0j)) * (x3**3)
                
            fext2 += \
                ((0.0 + 0.0j)) * (x1**3) +\
                ((0.0 + 0.0j)) * (x1**2) * x3 +\
                ((-1.9190930155250864e-51+1.9694513250391543e-37j)) * x1 * (x3**2) +\
                ((0.0 - 0.0j)) * (x3**3)
                
        return np.array([[fext1, fext2]]).transpose() / self.preconditioner
    
    def linear_term(self, state: np.ndarray) -> np.ndarray:
        """
        Calculates the linear term.

        :param state: State vector
        :return: Linear term array
        """
        return self.linear_coefficient @ state

    def nonlinear_term(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Calculates the nonlinear term.

        :param state: State vector
        :return: Nonlinear term array
        """
        if not self.nonlinear:
            return np.zeros_like(state)
        
        x0 = state[..., 0:1, :] * self.preconditioner
        x2 = state[..., 1:2, :] * self.preconditioner
        
        cos_aux = self.P * np.array(np.cos(adimensional_time))[...,np.newaxis,np.newaxis]
        sin_aux = self.P * np.array(np.sin(adimensional_time))[...,np.newaxis,np.newaxis]
        
        x1 = cos_aux + 1j*sin_aux
        x3 = np.conj(x1)

        # 26 terms # 29 terms
        fnl1 = \
            ((0.0 + 0.0j)) * (x0**3) +\
            ((0.0 + 0.0j)) * (x0**2) * x1 +\
            ((1.0723727965889998e-12+2.0951465157109213j)) * (x0**2) * x2 +\
            ((1.2143746561861231e-25-2.5082707049992177e-13j)) * (x0**2) * x3 +\
            ((0.0 - 0.0j)) * x0 * (x2**2) +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) * x0 * x1 * x2 +\
            ((0.0 - 0.0j)) * x0 * x2 * x3 +\
            ((0.0 + 0.0j)) * x0 * (x1**2) +\
            ((-1.2644564834232375e-37+3.758180994294173e-25j)) * x0 * x1 * x3 +\
            ((0.0 + 0.0j)) * x0 * (x3**2) +\
            ((1.1572247092763834e-37-1.6836372869586244e-24j)) * (x1**2) * x2 +\
            ((0.0 - 0.0j)) * x2**3  +\
            ((0.0 - 0.0j)) * x2**2 * x1 +\
            ((0.0 - 0.0j)) * (x2**2)*x3 +\
            ((0.0 - 0.0j)) * (x2) * x1**2 +\
            ((-2.314449418552767e-37-3.367274573917249e-24j)) * x2 * (x3) * x1 +\
            ((0.0 - 0.0j)) * (x2) * x3**2  
            
        fnl2 = \
            ((0.0 + 0.0j)) * (x0**3) +\
            ((0.0 + 0.0j)) * (x0**2) * x1 +\
            ((0.0 + 0.0j)) * (x0**2) * x2 +\
            ((0.0 + 0.0j)) * (x0**2) * x3 +\
            ((1.0723727965889998e-12+2.0951465157109213j)) * x0 * (x2**2) +\
            ((0.0 + 0.0j)) * x0 * x1 * x2 +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) * x0 * x2 * x3 +\
            ((0.0 + 0.0j)) * x0 * (x1**2) +\
            ((0.0 + 0.0j)) * x0 * x1 * x3 +\
            ((1.1572247092763834e-37+1.6836372869586244e-24j)) * x0 * (x3**2) +\
            ((0.0 - 0.0j)) * (x1**2) * x2 +\
            ((0.0 - 0.0j)) * x2**3  +\
            ((1.2143746561861231e-25+2.5082707049992177e-13j)) * x2**2 * x1 +\
            ((0.0 - 0.0j)) * (x2**2)*x3 +\
            ((0.0 - 0.0j)) * (x2) * x1**2 +\
            ((-1.2644564834232375e-37-3.758180994294173e-25j)) * x2 * (x3) * x1 +\
            ((0.0 - 0.0j)) * (x2) * x3**2   
        
        return np.concatenate((fnl1, fnl2), axis=-2) / self.preconditioner
    
    def all_terms(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Combines all terms (linear, nonlinear, external) to compute the total force.

        :param state: State vector
        :param adimensional_time: Time for evaluating external force
        :return: Total force array
        """
        return self.linear_term(state) + \
                self.nonlinear_term(state, adimensional_time) + \
                self.external_term(adimensional_time)
            
    def jacobian_nonlinear_term(self, state: np.ndarray, adimensional_time: np.ndarray) -> np.ndarray:
        """
        Computes the Jacobian of the nonlinear term.

        :param state: State vector
        :return: Jacobian of the nonlinear term
        """
        if not self.nonlinear:
            zeros = np.zeros_like(state)
            return np.concatenate((zeros, zeros), axis=-1)
        
        x0 = state[..., 0:1, :]
        x2 = state[..., 1:2, :]

        x1 = self.P * np.array(np.cos(adimensional_time))[...,np.newaxis,np.newaxis]
        x3 = self.P * np.array(np.sin(adimensional_time))[...,np.newaxis,np.newaxis]
        
        dx0_fnl1 = \
            ((0.0 + 0.0j)) * 3* (x0**2) +\
            ((0.0 + 0.0j)) * 2* (x0**1) * x1 +\
            ((1.0723727965889998e-12+2.0951465157109213j)) * 2* (x0**1) * x2 +\
            ((1.2143746561861231e-25-2.5082707049992177e-13j)) * 2 * (x0**1) * x3 +\
            ((0.0 - 0.0j)) * (x2**2) +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) *  x1 * x2 +\
            ((0.0 - 0.0j)) *  x2 * x3 +\
            ((0.0 - 0.0j)) *  (x1**2) +\
            ((-1.2644564834232375e-37+3.758180994294173e-25j)) *  x1 * x3 +\
            ((0.0 + 0.0j)) *  (x3**2) 
            
            
            
        dx0_fnl2 = \
            ((0.0 + 0.0j)) * 3* (x0**2) +\
            ((0.0 + 0.0j)) * 2* (x0**1) * x1 +\
            ((0.0 + 0.0j)) * 2* (x0**1) * x2 +\
            ((0.0 + 0.0j)) * 2 * (x0**1) * x3 +\
            ((1.0723727965889998e-12+2.0951465157109213j)) * (x2**2) +\
            ((0.0 + 0.0j)) *  x1 * x2 +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) *  x2 * x3 +\
            ((0.0 - 0.0j)) *  (x1**2) +\
            ((0.0 + 0.0j)) *  x1 * x3 +\
            ((1.1572247092763834e-37+1.6836372869586244e-24j)) *  (x3**2)
            

            
        dx2_fnl1 = \
            ((1.0723727965889998e-12+2.0951465157109213j)) * (x0**2) +\
            ((0.0 - 0.0j)) * x0 * 2 * (x2**1) +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) * x0 * x1  +\
            ((0.0 - 0.0j)) * x0  * x3 +\
            ((1.1572247092763834e-37-1.6836372869586244e-24j)) * (x1**2) +\
            ((0.0 - 0.0j)) * 3 * x2**2  +\
            ((0.0 - 0.0j)) * 2 * x2**1 * x1 +\
            ((0.0 - 0.0j)) * 2 * (x2**1)*x3 +\
            ((0.0 - 0.0j)) *  x1**2 +\
            ((-2.314449418552767e-37-3.367274573917249e-24j)) *  (x3) * x1 +\
            ((0.0 - 0.0j)) *  x3**2     
            
        dx2_fnl2 = \
            ((0.0 + 0.0j)) * (x0**2) +\
            ((1.0723727965889998e-12+2.0951465157109213j)) * x0 * 2 * (x2**1) +\
            ((0.0 + 0.0j)) * x0 * x1  +\
            ((-1.2990693803586245e-24+2.8170671798092077e-12j)) * x0  * x3 +\
            ((0.0 - 0.0j)) * (x1**2) +\
            ((0.0 - 0.0j)) * 3 * x2**2  +\
            ((1.2143746561861231e-25+2.5082707049992177e-13j)) * 2 * x2**1 * x1 +\
            ((0.0 - 0.0j)) * 2 * (x2**1)*x3 +\
            ((0.0 - 0.0j)) *  x1**2 +\
            ((-1.2644564834232375e-37-3.758180994294173e-25j)) *  (x3) * x1 +\
            ((0.0 - 0.0j)) *  x3**2 

        jacobian0 = np.concatenate((dx0_fnl1, dx2_fnl1), axis=-1)
        jacobian1 = np.concatenate((dx0_fnl2, dx2_fnl2), axis=-1)
        
        return np.concatenate((jacobian0, jacobian1), axis=-2)